---
layout: post
title: Sprechanlage
date: 2019-09-10 00:00:00 +0100
description:  #
img: banner.png
imgfolder: /assets/img/ring/
tags: [openHAB, Rollladen, Automation, Klingel]
author: "Björn Engel"
lang: en
ref: ring
---

Eine Klingel mit Sprechanlage und Türöffner solte nachgerüstet werden. Die Wunschliste 

* Klingel, Gegensprechanlage, Ansteuerung Türöffner
* "mobiler Gong", um bei Bedarf auch auf der Terrasse, im Keller oder Garage ein Klingeln mitzubekommen
* openHAB sollte das Klingeln mitbekommen können

Ich habe mich bei der Wahl der Hardware für die Auerwald TFS Universal Plus entschieden. Dieses Gerät hat Lautsprecher und Mikrofon der Gegensprechanlage integriert und kommt mit 2 Drähten aus. Es agiert als Telefonnebenstelle an der vorhandenen Fritzbox und löst beim Klingeln einen internen Rundruf aus. Dadurch konnten die vorhandenen Schnurlostelfone genutzt werden, womit der "mobile Gong" aber vor allem auch das Gegenstück der Sprechanlage zufriedenstellend gelöst wurde.

Der Türöffner sollte über einen Softbutton am Displayrand bedient werden. Dieses Feature ist laut AVM allerdings den Fritz! Fonen vorbehalten, weshalb hier bei einem aktiven Gespräch eine Tastenkombination gedrückt werden muss.

Der eigentliche Knackpunkt, weshalb die Klingelanlage als Projekt auch hier auftaucht, ist die openHAB-Anbindung.

Urspünglich wollte ich das Fritzbox-Binding verwenden. Aus meiner Erfahrung wusste ich, dass ein- als auch ausgehende Anrufe sehr gut erkannt werden und entsprechend Regeln triggern können. Das Binding nutzt allerdings das API des Call-Monitors, der keine Informationen über interne Telefonate liefert.

Der nächste Versuch war die Verwendung eines CLI-IP-Telefonclients, der sich an der Fritz!Box anmeldet und der mit ein paar Anpassungen dann in openHAB integriert werden kann. Leider habe ich keine derartige Software gefunden.

Nachdem ich ein wenig rumprobiert habe, bin ich an der Softwaretelefonanlage Asterisk, die ich schon aus jugendlichen Experimenten kannte, hängen geblieben. Asterisk soll sich an der Fritz!Box als Client anmelden. Bei einem internen Rundruf sollte somit auch Asterisk Notiz bekommen.

Zur Umsetzung sind recht viele Schritte notwendig, die zwar in meinem Ansible-Playbook zur Aufsetzung des SmartHome-Servers dokumentiert, jedoch nicht zwangsweise nachvollziehbar beschrieben sind, so dass diese "Anleitung" zur Nachahmung animieren soll.

# Fritz!Box-Konfiguration

# Docker Container Asterisk
Ich wollte Asterisk nicht unbedingt installieren, da ich mich in der Vergangenheit bei solch komplexen Systemen regelmäßig mit Abhängigkeiten rumärgern musste, weshalb meine erste Wahl das offizielle(?) Docker-Image auf Debianbasis sein sollte. Kurz: funktioniert, aber mit 2,5GB etwas ressourcenhungrig nur für den Trigger *interner Anruf*.

Ich probierte ein wenig mit Alpine-Basisimages und installierte darin Asterisk. Heraus kam dieses Dockerfile und damit ein Image mit einer Größe von 43MB. Innernoch recht groß, um dieses eine Event zu triggern, aber nur 1,7% der ursprünglichen Größe - damit kann ich leben.
 
# Asterisk-Konfiguration

# Asterisk-Binding

Das Asterisk-Binding ist leider eines der inoffiziellen Features.

# openHAB-Konfiguration 

```ruby
```

[Bildnachweis Banner][piccredit]

[piccredit]: https://pixabay.com/de/photos/t%C3%BCr-klingel-eingang-haust%C3%BCr-864735/

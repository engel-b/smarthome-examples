---
layout: post
title: Sprechanlage
date: 2019-09-10 00:00:00 +0100
description:  #
img: banner.png
imgfolder: /assets/img/ring/
tags: [openHAB, Rollladen, Automation, Klingel]
author: "Björn Engel"
lang: de
ref: ring
---

Eine Klingel mit Sprechanlage und Türöffner solte nachgerüstet werden. Die Wunschliste 

* Klingel, Gegensprechanlage, Ansteuerung Türöffner
* "mobiler Gong", um bei Bedarf auch auf der Terrasse, im Keller oder Garage ein Klingeln mitzubekommen
* openHAB sollte das Klingeln mitbekommen können

Ich habe mich bei der Wahl der Hardware für die Auerwald TFS Universal Plus entschieden. Dieses Gerät hat Lautsprecher und Mikrofon der Gegensprechanlage integriert und kommt mit 2 Drähten aus. Es agiert als Telefonnebenstelle an der vorhandenen Fritzbox und löst beim Klingeln einen internen Rundruf aus. Dadurch konnten die vorhandenen Schnurlostelfone genutzt werden, womit der "mobile Gong" aber vor allem auch das Gegenstück der Sprechanlage zufriedenstellend gelöst wurde.

![TFS Universal Plus][tfs-universal-plus]

Der Türöffner sollte über einen Softbutton am Displayrand bedient werden. Dieses Feature ist laut AVM allerdings den Fritz! Fonen vorbehalten, weshalb hier bei einem aktiven Gespräch eine Tastenkombination gedrückt werden muss.

Der eigentliche Knackpunkt, weshalb die Klingelanlage als Projekt auch hier auftaucht, ist die openHAB-Anbindung.

Urspünglich wollte ich das Fritzbox-Binding verwenden. Aus meiner Erfahrung wusste ich, dass ein- als auch ausgehende Anrufe sehr gut erkannt werden und entsprechend Regeln triggern können. Das Binding nutzt allerdings das API des Call-Monitors, der keine Informationen über interne Telefonate liefert.

Der nächste Versuch war die Verwendung eines CLI-IP-Telefonclients, der sich an der Fritz!Box anmeldet und der mit ein paar Anpassungen dann in openHAB integriert werden kann. Leider habe ich keine derartige Software gefunden.

Nachdem ich ein wenig rumprobiert habe, bin ich an der Softwaretelefonanlage Asterisk, die ich schon aus jugendlichen Experimenten kannte, hängen geblieben. Asterisk soll sich an der Fritz!Box als Client anmelden. Bei einem internen Rundruf sollte somit auch Asterisk Notiz bekommen.

Zur Umsetzung sind recht viele Schritte notwendig, die zwar in meinem Ansible-Playbook zur Aufsetzung des SmartHome-Servers dokumentiert, jedoch nicht zwangsweise nachvollziehbar beschrieben sind, so dass diese "Anleitung" zur Nachahmung animieren soll.

# Fritz!Box-Konfiguration

An der Fritz!Box müssen 2 Endgeräte eingerichtet werden: die Sprechanlage, ein IP-Telefon für Asterisk.

## Sprechanlage

Telefonie -> Telefoniegeräte -> Neues Gerät einrichten

![New phone][new-phone]

Türsprechanlage -> Anschluss wählen -> ...

## IP-Telefon zur Anmeldung von Asterisk

Telefonie -> Telefoniegeräte -> Neues Gerät einrichten

new-telefon.png

Telefon -> LAN/WLAN (IP-Telefon)). 

![Neues IP Telefon][new-ip-phone]

Anschließend einen Benutzernamen und ein Passwort festlegen (und merken), aus- und eingehende Rufnummer definieren.

![IP Telefon konfigurieren][config-ip-phone]

# Docker Container Asterisk
Ich wollte Asterisk nicht unbedingt installieren, da ich mich in der Vergangenheit bei solch komplexen Systemen regelmäßig mit Abhängigkeiten rumärgern musste, weshalb meine erste Wahl das offizielle(?) Docker-Image auf Debianbasis sein sollte. Kurz: funktioniert, aber mit 2,5GB etwas ressourcenhungrig nur für den Trigger *"interner Anruf"*.

Ich probierte ein wenig mit Alpine-Basisimages und installierte darin Asterisk. Heraus kam dieses Dockerfile und damit ein Image mit einer Größe von 43MB. Immernoch recht groß, um dieses eine Event zu triggern, aber nur 1,7% der ursprünglichen Größe - damit kann ich leben.

Das Dockerfile ist hier zu finden (https://github.com/justcoke/alpine-asterisk). Gebaut wird das Image mit

```shell
docker build .
```

Gestartet wird ein entsprechender Container mit

```shell
docker run --tty -v <LOCAL_ASTERISK_DIR>:/etc/asterisk <image>
```

# Asterisk-Konfiguration

Asterisk erstellt m. E. ein Set an Konfigurationsfiles, wenn keine vorhanden sind. Jedoch brauche ich für meinen Anwendungsfall nur einen sehr kleinen Teil.

In meinem Ansible Playbook zur Einrichtung meines Hausautomatisierungsservers habe ich die erforderlichen Konfigurationsdateien zusammengetragen (https://github.com/justcoke/ansible-smarthome/tree/master/roles/asterisk/templates/conf). 

## asterisk.conf + console.conf + logger.conf + modules.conf

Sind alles Standardkonfigurationen, wobei ich hier wahrscheinlich diverse Funktionen deaktiviert habe.

## extensions.conf

Das Regelwerk mit 2 Regeln zum Testen.

1. eine Hello-World-Regel um das laufende Asterisk testen zu können
2. eine Regel, die nach 30 Sekunden das Gespräch annimmt, "Hello world" sagt und das Gespräch beendet. Eigentlich sollte diese Regel nie greifen, da die Sprechanlage so konfiguriert ist, dass sie den Rundruf nur 20 Sekunden durchführt.

## manager.conf

Dies ist das Konfigurationsfile des AMI (Asterisk Manager Interface). Das AMI ist erforderlich, damit openHAB eine Verbindung zu Asterisk aufbauen kann. Ab Zeile 158 wird es interessant, da hier Benutzername und Passwort festgelegt werden. Weiterhin lässt sich hier auch der Zugriff aus dem Netzwerk einschränken.

## sip.conf

Hier wird definiert, dass sich Asterisk als Sip-Client an der Fritz!Box anmelden soll. Benötigt wird dafür der zuvor in der Fritz!Box festgelegte Benutzername als auch dessen Passwort und die Adresse der Fritz!Box.    

# Asterisk-Binding

Das Asterisk-Binding ist leider eines der inoffiziellen Features. Ich habe es hier (https://openhab.jfrog.io/openhab/libs-pullrequest-local/org/openhab/binding/org.openhab.binding.asterisk/1.14.0-SNAPSHOT/) heruntergeladen. Das jar-File ist dann in das addons-Verzeichnis zu schieben

# openHAB-Konfiguration 

```ruby
```

[Bildnachweis Banner][piccredit]

[tfs-universal-plus]: {{ "tfs-universal-plus.png" | prepend: page.imgfolder | prepend: site.baseurl }} "Auerwald TFS Universal Plus"
[new-phone]: {{ "new-phone.png" | prepend: page.imgfolder | prepend: site.baseurl }} "Neues Telefon"
[new-ip-phone]: {{ "new-ip-phone.png" | prepend: page.imgfolder | prepend: site.baseurl }} "Neues IP-Telefon"
<<<<<<< HEAD
[config-ip-phone]: {{ "config-ip-phone.png" | prepend: page.imgfolder | prepend: site.baseurl }} "IP-Telefon konfigurieren"
=======
[config-ip-phone]: {{ "config-ip-phone" | prepend: page.imgfolder | prepend: site.baseurl }} "IP-Telefon konfigurieren"
>>>>>>> branch 'gh-pages' of https://github.com/justcoke/smarthome-examples.git
[piccredit]: https://pixabay.com/de/photos/t%C3%BCr-klingel-eingang-haust%C3%BCr-864735/
